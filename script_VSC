cd /user/leuven/363/vsc36367/pacbiocheck
conda activate qiime2-amplicon-2025.4

mkdir -p raw_data_rc raw_data_cat trimmed_reads

# 1) reverse-complement each input
parallel -j 2 'zcat -f {} | seqtk seq -r - | gzip -c > raw_data_rc/{/.}_rc.fastq.gz' ::: ./*.fastq.gz

# 1b) concatenate original + RC per file (decompress -> concat -> recompress once)
for f in ./*.fastq.gz; do
  b=${f%.gz}  # e.g. ./GC172404.fastq
  cat <(zcat -f "$f") <(zcat -f "raw_data_rc/${b}_rc.fastq.gz") | gzip -c > "raw_data_cat/${b}_cat.fastq.gz"
done

# 2) trim primers (YOU must replace FWD_PRIMER and REV_PRIMER with real sequences)
FWD_PRIMER='AGRGTTYGATYMTGGCTCAG'
REV_PRIMER='AAGTCGTAACAAGGTARCY'

parallel -j 2 'cutadapt -g "$FWD_PRIMER" -a "$REV_PRIMER" --discard-untrimmed --no-indels -j 1 -m 1200 -M 1800 -o trimmed_reads/{/.}_trim.fastq.gz {}' ::: raw_data_cat/*_cat.fastq.gz


3. import sequences as a qiime2 artifact
mkdir -p reads_qza

echo "sample-id,absolute-filepath,direction" > trimmed_manifest.csv
for f in trimmed_reads/*_trim.fastq*; do
  sid=$(basename "$f")
  sid=${sid%_trim.fastq*}
  echo "${sid},$(readlink -f "$f"),forward" >> trimmed_manifest.csv
done
#inspect once: 
column -t -s, trimmed_manifest.csv

#import to qiime

qiime tools import \
  --type SampleData[SequencesWithQuality] \
  --input-path trimmed_manifest.csv \
  --output-path reads_qza/trimmed_reads.qza \
  --input-format SingleEndFastqManifestPhred33

  #check
  qiime demux summarize \
  --i-data reads_qza/trimmed_reads.qza \
  --o-visualization reads_qza/trimmed_reads.qzv

HIER GERAAKT!!!!!!!!!!!!!!!!!!!!!!!
  4. DADA2 denoising
mkdir -p dada2_output
#!/bin/bash
#SBATCH --job-name=dada2
#SBATCH --account=lkulak_daphnia_gp
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G
#SBATCH --time=08:00:00
#SBATCH --output=logs/dada2_%j.out
#SBATCH --error=logs/dada2_%j.err
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=kristina.yefimak@kuleuven.be

set -euo pipefail

cd "$SLURM_SUBMIT_DIR"

# Conda init (batch-proof)
source /data/leuven/363/vsc36367/miniconda3/etc/profile.d/conda.sh
conda activate qiime2-amplicon-2025.4

# Keep temp files in project (HPC-friendly)
mkdir -p logs qiime2_tmp dada2_output
export TMPDIR="$PWD/qiime2_tmp"
export TMP="$PWD/qiime2_tmp"
export TEMP="$PWD/qiime2_tmp"

# Prevent R/BLAS thread oversubscription
export OMP_NUM_THREADS=1
export OPENBLAS_NUM_THREADS=1
export MKL_NUM_THREADS=1
export VECLIB_MAXIMUM_THREADS=1
export NUMEXPR_NUM_THREADS=1

# DADA2 (one line to avoid line-continuation issues)
qiime dada2 denoise-single --i-demultiplexed-seqs reads_qza/trimmed_reads.qza --p-trunc-len 0 --p-n-threads 8 --p-n-reads-learn 100000 --p-max-ee 2 --o-table dada2_output/table.qza --o-representative-sequences dada2_output/rep-seqs.qza --o-denoising-stats dada2_output/denoising-stats.qza --verbose


OR

qiime dada2 denoise-single \
  --i-demultiplexed-seqs reads_qza/trimmed_reads.qza \
  --p-trunc-len 0 \
  --p-n-threads 8 \
  --p-n-reads-learn 100000 \
  --p-max-ee 2 \
  --o-table dada2_output/table.qza \
  --o-representative-sequences dada2_output/rep-seqs.qza \
  --o-denoising-stats dada2_output/denoising-stats.qza

#check

qiime metadata tabulate \
  --m-input-file dada2_output/denoising-stats.qza \
  --o-visualization dada2_output/denoising-stats.qzv

5. convert artifact to readable format
 mkdir -p dada2_output_exported

# 1) Export denoising stats (creates a .tsv)
qiime tools export \
  --input-path dada2_output/denoising-stats.qza \
  --output-path dada2_output_exported/denoising-stats

# 2) Export feature table (creates feature-table.biom)
qiime tools export \
  --input-path dada2_output/table.qza \
  --output-path dada2_output_exported/table

# 3) Export representative sequences (creates dna-sequences.fasta)
qiime tools export \
  --input-path dada2_output/rep-seqs.qza \
  --output-path dada2_output_exported/rep-seqs

# 4) Convert BIOM -> TSV (human readable)
biom convert \
  -i dada2_output_exported/table/feature-table.biom \
  -o dada2_output_exported/table/feature-table.tsv \
  --to-tsv
#check
find dada2_output_exported -maxdepth 2 -type f -print
head -n 5 dada2_output_exported/denoising-stats/stats.tsv
head -n 5 dada2_output_exported/rep-seqs/dna-sequences.fasta

6. assign taxonomy
time qiime feature-classifier classify-consensus-vsearch \
  --i-query dada2_output/rep-seqs.qza \
  --i-reference-reads /home/share/Q2_Silva99_DB/Silva99_16SRepSeq.qza \
  --i-reference-taxonomy /home/share/Q2_Silva99_DB/Silva99_16STaxonomy.qza \
  --p-maxaccepts 1 \
  --p-strand both \
  --p-threads 10 \
  --verbose \
  --output-dir taxa

#Export taxonomy to readable format
qiime tools export \
  --input-path taxa/classification.qza \
  --output-path taxa
#creates taxa/taxonomy.tsv

#check:
head -n 10 taxa/taxonomy.tsv

7. annotate feature table
# Fix taxonomy header for BIOM
sed -i \
  -e '1 s/^Feature ID/#OTUID/' \
  -e '1 s/^Taxon/taxonomy/' \
  taxa/taxonomy.tsv

# Add taxonomy to the feature table
biom add-metadata \
  -i dada2_output_exported/table/feature-table.biom \
  -o dada2_output_exported/table/feature-table_w_tax.biom \
  --observation-metadata-fp taxa/taxonomy.tsv \
  --sc-separated taxonomy

# Convert to readable TSV
biom convert \
  -i dada2_output_exported/table/feature-table_w_tax.biom \
  -o dada2_output_exported/table/feature-table_w_tax.tsv \
  --to-tsv \
  --header-key taxonomy

#COMPARE WHICH OF THE 2 SAMPLES HAS MORE DIFFERENT TAXA
-Does one kit recover higher richness / diversity?
-Does one kit recover a broader taxonomic spectrum?
-Are the differences consistent across rarefaction depths?

3️⃣ Step 1 — Generate alpha diversity in QIIME 2
#Pick a depth that both samples support:
qiime diversity alpha \
  --i-table dada2_output/table.qza \
  --p-metric observed_features \
  --o-alpha-diversity observed_features.qza
#Also compute Shannon (accounts for evenness):

qiime diversity alpha \
  --i-table dada2_output/table.qza \
  --p-metric shannon \
  --o-alpha-diversity shannon.qza
#Export:

qiime tools export \
  --input-path observed_features.qza \
  --output-path exported_alpha

qiime tools export \
  --input-path shannon.qza \
  --output-path exported_alpha

RAREFACTION CURVES
qiime diversity alpha-rarefaction \
  --i-table dada2_output/table.qza \
  --p-max-depth 20000 \
  --o-visualization alpha_rarefaction.qzv
#Higher curve = higher richness

5️⃣ Step 3 — Export to R for proper comparison
qiime tools export --input-path dada2_output/table.qza --output-path exported
qiime tools export --input-path taxonomy.qza --output-path exported
_______________________________________________________
IN RSTUDIO

library(phyloseq)
library(vegan)

otu <- import_biom("exported/feature-table.biom")
tax <- read.table("exported/taxonomy.tsv", sep="\t", header=TRUE)
tax_mat <- as.matrix(do.call(rbind, strsplit(tax$Taxon, ";")))
rownames(tax_mat) <- tax$Feature.ID
ps <- phyloseq(otu, tax_table(tax_mat))

estimate_richness(ps, measures = c("Observed", "Shannon"))

#This gives you direct richness numbers per extraction kit.
______________________________________________
ps_rel <- transform_sample_counts(ps, function(x) x / sum(x))
dist <- vegdist(t(otu_table(ps_rel)), method = "bray")
dist
#This gives a Bray–Curtis distance between the two kits (0 = identical, 1 = completely different).
